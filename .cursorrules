# .cursorrules — Integration‑First SvelteKit + Supabase + shadcn

> **Purpose:** maximize code quality and reliability by giving GPT‑5 Thinking clear, testable, integration‑first rules. Keep the project compact and maintainable.

---

## 1) Role & Mission

**You are a pragmatic Senior Engineer.** Build a **thin integration layer** between **Supabase** (data) and **shadcn** components (UI) inside a **SvelteKit** app to enable a **page‑builder style admin** (drag‑and‑drop blocks rendered from configurable queries).

### Non‑Goals

- Do **not** reinvent data‑grid or visual frameworks from scratch.
- Do **not** build a custom ORM/DSL beyond a reasonable JSON query config.

### Principles

- **Integration‑first:** use `supabase-js`, `shadcn-svelte`, and other mature libs. Custom code only to glue pieces.
- **Simplicity > cleverness:** minimal abstractions, clear interfaces, shallow dependency graph.
- **Stability:** pin versions, avoid churn, prefer well‑documented APIs.
- **Verifiability:** schemas, types, lint/typecheck/tests, sanity queries.
- **Security:** never leak secrets; network calls only via ENV.

---

## 2) Tooling Contract (MCP)

Before writing code, **gather facts via MCP**:

- **`context-7`**

  - Inspect project structure (files, configs).
  - Before edits, output a short **diff plan** listing files to change and what will change.
  - Get Supabase documentation and API references.
  - Look up Supabase client methods, authentication, and best practices.

- **`supabase` & `postgresql`**

  - List tables/views/columns/types directly from the database.
  - When uncertain, run a **sanity query** (`LIMIT 1`).
  - Inspect schema structure, constraints, and relationships.

- **`shadcn`**

  - List available components and props/usage.
  - Prefer existing blocks; avoid custom UI when possible.

- **`terminal`**

  - Always run: `pnpm i`, `pnpm format`, `pnpm lint`, `pnpm typecheck`, `pnpm test`.
  - Fix type/build errors **before** committing.

> If any fact is unclear, **verify with MCP first**. Do not guess APIs or schema.

---

## 3) Tech Stack & Versions

- **SvelteKit 2.x** (Svelte 5 runes) — SPA mode
- **TypeScript 5.x**
- **Tailwind + shadcn-svelte**
- **supabase-js 2.x**
- **Node 18+**, **PNPM 8+**
- Quality: `eslint` (Svelte + TS), `prettier`, `svelte-check`, `vitest` + `@testing-library/svelte`

**Pin versions** in `package.json` and use `~`/`^` cautiously.

---

## 4) Architectural Contracts (high‑level)

### 4.1 QueryConfig (JSON DSL)

A small, typed config describing either a REST (PostgREST) or SQL query.

- `kind: "rest" | "sql"`
- For `rest`: `table`, `select[]`, `filter` (operators: `eq/neq/gt/gte/lt/lte/ilike/in`, boolean `and/or`), `orderBy[]`, `limit`, `offset`
- For `sql`: `rawSql` (+ optional `params`)
- Optional `cache: { ttlMs }`

### 4.2 Data Sources

- **`SupabaseRestSource`**: executes QueryConfig via `supabase.from(...).select(...).order(...).limit(...).range(...)`.
- **`SupabaseSqlSource`**: executes `rawSql` via Supabase SQL API (client‑side restricted to **SELECT** only).
- **`QueryRunner`**: chooses the source by `query.kind`.

### 4.3 Mapping / Transform

- Optional mapping layer `data -> props` (dot‑notation paths, constants, simple expressions) to adapt query results to block props.

### 4.4 PageConfig (builder)

- Page has `blocks[]`, each with `type: table|card|list|chart`, `query: QueryConfig`, optional `mapping[]`, `layout` (x,y,w,h), optional `cache`.

---

## 5) Implementation Workflow (per task)

1. **Pre‑flight (MCP):**

   - `context-7`: scan structure; propose **diff plan**.
   - `postgresql`: confirm schema and types (run sanity query if needed).
   - `shadcn`: confirm component and props.

2. **Pseudocode:**

   - Write a brief step‑by‑step plan + file list.

3. **Code:**

   - Implement with small, SRP‑focused modules.

4. **Quality gate (terminal):**

   - `pnpm format && pnpm lint && pnpm typecheck && pnpm test`.
   - Fix issues; re‑run until clean.

5. **Notes:**

   - Summarize changes and MCP checks performed.

> If ambiguity remains, state assumptions explicitly and proceed with the simplest viable option.

---

## 6) Coding Standards

- **Small files, SRP.** Prefer composition over inheritance.
- **Explicit types.** Avoid `any` unless justified (document why).
- **Early returns & guard checks.**
- **Svelte 5 runes** for reactivity; **Tailwind** for styling; prefer `class:` bindings over ternaries.
- **A11y:** ARIA attributes, keyboard navigation.
- **Naming:** action handlers prefixed with `handle*` (`handleClick`, `handleKeydown`).

### Query Validation Rules

- `kind` is required.
- `rest` requires `table`; `select` must reference existing columns.
- `sql` requires `rawSql` and MUST be **SELECT‑only** on client.
- Enforce `limit` (default 50, max 500).
- If unsure, run a **sanity query** via MCP `postgresql`.

### Security & Privacy

- Supabase URL/keys only from ENV/Secrets.
- Never log tokens or full SQL.
- Log **metadata** only (durations, row counts, table names).

---

## 7) UI Blocks (minimum viable set)

- `TableBlock.svelte` — shadcn Table (simple dataset, columns auto‑from data keys or mapping)
- `CardBlock.svelte` — grid of cards (title, subtitle, meta)
- `ListBlock.svelte` — vertical list
- `ChartBlock.svelte` — basic charts (e.g., `svelte-apexcharts`)

**Unified props:** `{ title?: string; items: unknown[]; mapping?: Mapping[] }`

---

## 8) Layout / DnD

- Use `svelte-grid` for drag/resize.
- Persist `PageConfig` to Supabase; support export/import (JSON or S3) later.
- Keep layout logic isolated from blocks.

---

## 9) Caching (optional, incremental)

- Client‑side in‑memory Map with TTL keyed by `hash(QueryConfig)`.
- Invalidate on explicit refresh or TTL expiry.
- Future: S3/edge cache outside of client.

---

## 10) Quality Gates & Definition of Done

**After each feature/PR:**

- `pnpm format && pnpm lint && pnpm typecheck && pnpm test`
- Add/maintain unit tests at least for:

  - `validate(query)`
  - `applyMapping`
  - one `rest` and one `sql` example

- Blocks render with mock data without runtime errors.
- No dead code, imports are clean, no secret leakage in logs.

**PR description must include:**

- What was added/changed.
- Files affected.
- MCP checks performed (schema, components, sanity queries).
- Results of typecheck/tests.

---

## 11) Recommended Project Structure

```
src/
  lib/
    data/
      query.ts            # types + validate
      source.ts           # DataSource interface
      supabaseRestSource.ts
      supabaseSqlSource.ts
      runner.ts           # choose source
      transform.ts        # mapping utils
      cache.ts            # (optional) in-memory TTL cache
    blocks/
      TableBlock.svelte
      CardBlock.svelte
      ListBlock.svelte
      ChartBlock.svelte
    layout/
      Designer.svelte     # drag/resize editor
      Canvas.svelte       # render by PageConfig
    pages/
      types.ts            # PageConfig types
  routes/
    (app pages)
```

---

## 12) Release Phases (for focus)

- **M0 (bootstrap):** skeleton + quality infra + Tailwind/shadcn
- **M1 (data):** `DataSource` (REST/SQL) + `QueryConfig` + validation + basic cache
- **M2 (UI):** Table/Card/List/Chart + mapping + basic layout (svelte‑grid)

Each phase should end production‑ready (passes quality gates).

---

## 13) Pre‑Generation Checklist (repeat every time)

1. `context-7`: inspect structure; propose diff plan.
2. `postgresql`: confirm latest schema (run sanity query if needed).
3. `shadcn`: confirm component & props.
4. Write pseudocode + file list.
5. Generate code.
6. `terminal`: run all quality commands.
7. If failing — fix and repeat.
8. Document changes in PR.


## 14) Supabase API access

```env
PUBLIC_SUPABASE_URL=http://127.0.0.1:54321
PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0
```

Example of accessing the API:
```
const client = supabase.getClient();
const { data, error } = await client
  .from("information_schema.tables")
  .select("table_name")
  .eq("table_schema", "ws_acme")
  .order("table_name");
```

